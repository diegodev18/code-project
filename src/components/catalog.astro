---
import SearchVar from "@/components/searchVar.astro";
import CategoriesGallery from "@/components/categoriesGallery.astro";
import ProjectsGallery from "@/components/projectsGallery.astro";
import getProgress from "@/utils/getProgressProjects";
import getFavorites from "@/utils/getFavorites";
import getSession from "@/utils/getSession";
import ProjectsSmallCard from "@/components/projectsSmallCard.astro";
import { supabase } from "@/lib/supabase";
import CircleDashedPlus from "@/components/icons/circleDashedPlus.astro";

let { data: Projects } = await supabase
        .from("projects")
        .select("icon, title, description, href, id")
        .eq("status", "public");

const session = await getSession(Astro);

const user_fav = await getFavorites(session?.user_metadata.user_name || "");
const user_progress = await getProgress(session?.user_metadata.user_name || "");
---

<SearchVar />
<CategoriesGallery />
<ProjectsGallery
id="main"
cards={[...(Projects ?? [])]}
user_name={session?.user_metadata.user_name}
/>
<ProjectsGallery
id="love"
title="Podrian gustarte"
cards={[...(Projects ?? [])]}
small={false}
user_name={session?.user_metadata.user_name}
/>
{
    user_progress && user_progress?.length != 0 && (
        <ProjectsGallery
        id="continue"
        title="Seguir aprendiendo"
        cards={[...(user_progress ?? [])].filter((item): item is NonNullable<typeof item> => item !== undefined)}
            user_name={session?.user_metadata.user_name}
        />
    )
}
<ProjectsGallery
id="fav"
title="Favoritos"
cards={[...(user_fav ?? [])].filter((item): item is NonNullable<typeof item> => item !== undefined)}
    user_name={session?.user_metadata.user_name}
>
    <ProjectsSmallCard user_name={session?.user_metadata.user_name} id={'add-fav'} href={'#fav'} title={'Explora los proyectos que mas te llamen'} description={'Inicia ahora con los proyectos que mas te agradan'} icon={{ width: 85, height: 85, component: CircleDashedPlus }} />
</ProjectsGallery>